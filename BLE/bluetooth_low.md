© 2024 . 未经许可不得复制、修改或分发。 此文献为 [小風的藏書閣](https://t.me/xfp2333) 所有。

# 什么是低功耗蓝牙 (Bluetooth Low Energy, BLE)？

低功耗蓝牙（Bluetooth Low Energy, BLE）是一种旨在显著降低功耗和成本，同时保持通信范围相对较远的无线通信技术。它最初是作为蓝牙4.0标准的一部分发布的，适用于需要长时间运行但不常通信的设备，如可穿戴设备、传感器和智能家居设备。

# 什么是经典蓝牙 (Classic Bluetooth)？

经典蓝牙（Classic Bluetooth）是一种用于无线传输数据和音频的技术，最初在1999年作为蓝牙1.0标准推出。它适用于数据传输速度较高、通信频率较高的应用，如无线耳机、键盘、鼠标和音响设备。

# 低功耗蓝牙和经典蓝牙有什么区别？

1. **功耗**：
   - **低功耗蓝牙**：设计用于极低功耗设备，可以使设备的电池寿命长达数年。
   - **经典蓝牙**：功耗较高，适用于需要频繁数据传输的设备。

2. **数据传输速率**：
   - **低功耗蓝牙**：数据传输速率较低，适用于简单数据的传输。
   - **经典蓝牙**：数据传输速率较高，适用于音频和大数据传输。

3. **应用场景**：
   - **低功耗蓝牙**：常用于可穿戴设备、健康设备、智能家居传感器等。
   - **经典蓝牙**：常用于无线耳机、音响、电脑外设等。

4. **连接方式**：
   - **低功耗蓝牙**：连接时间短，可以快速建立连接。
   - **经典蓝牙**：连接时间相对较长，但稳定性更高。

# 什么是UUID？

UUID（Universally Unique Identifier，通用唯一识别码）是一种128位的标识符，用于唯一标识信息。在蓝牙技术中，UUID用于区分不同的服务和特征，使设备能够识别和访问特定的数据和功能。UUID保证在不同设备和应用之间的唯一性，避免冲突。

# 什么是蓝牙协议栈？

蓝牙协议栈是蓝牙设备进行通信时使用的一系列协议和标准的集合。它定义了数据传输的方式和设备之间的交互规则。蓝牙协议栈主要分为以下几个层次：

1. **控制器层**：
   - **物理层 (PHY)**：负责蓝牙信号的物理传输。
   - **链路层 (Link Layer, LL)**：负责蓝牙设备之间的连接建立和维护。

2. **主机层**：
   - **逻辑链路控制和适配协议 (L2CAP)**：负责数据封装和协议复用。
   - **属性协议 (ATT)**：定义了蓝牙设备之间的数据访问方式。
   - **通用属性配置文件 (GATT)**：定义了使用属性协议的服务和特征。
   - **安全管理协议 (SMP)**：负责设备配对和加密。
   - **通用访问配置文件 (GAP)**：定义了设备发现和连接的流程。

3. **应用层**：
   - **服务和特征**：定义了具体的功能和数据格式，如心率监测、温度传感等。

通过这些层次的协作，蓝牙协议栈能够实现设备发现、连接建立、数据传输和安全管理等功能，使蓝牙设备能够在不同应用场景中可靠地工作。


# 低功耗蓝牙架构

低功耗蓝牙（BLE）设备的工作原理可以分为以下几个部分：

## 1. BLE设备的角色

### 广播状态和连接状态

- **广播者 (Advertiser)**：在广播状态下发送广播数据包，可以被其他设备扫描和连接。
- **扫描者 (Scanner)**：在扫描状态下接收广播数据包，通常用来发现附近的BLE设备。

### 连接状态

- 在连接状态下，BLE设备可以进行一对多的连接，即一个设备可以同时与多个其他设备进行通信。
- **服务端 (Server)**：提供数据和服务的设备。
- **客户端 (Client)**：获取数据和服务的设备。

## 2. GAP (Generic Access Profile)

GAP定义了BLE设备的角色和操作方式，包括设备发现、连接建立和连接管理。GAP角色包括扫描者（Scanner）和广播者（Advertiser）。

## 3. GATT (Generic Attribute Profile)

GATT定义了BLE设备之间的数据交换方式和数据格式，包括以下操作：

### GATT定义的操作

1. **发现服务与特征值**：
   - 客户端可以发现服务端提供的所有服务和特征值。

2. **读写特征值**：
   - 客户端可以读取和写入服务端的特征值。

3. **通知**：
   - 服务端可以向客户端发送通知，告知特定特征值的变化。

4. **广播特征值的配置**：
   - 配置广播特征值，使其在广播中包含特定的数据。

### GATT定义的数据格式

1. **服务 (Service)**：
   - 服务是数据的集合，包含一个或多个特征值。
   - 一个设备可以提供多个服务。

2. **特征值 (Characteristic)**：
   - 特征值是数据的基本单位，包含一个值和一组属性。
   - 特征值可以包括描述该值的附加信息。

### GATT程序

1. **发现服务与特征值**
2. **读写特征值**
3. **通知**
4. **广播特征值的配置**

## 4. Profile

### 具有阶层架构

- Profile由一个或多个服务组成，定义设备的功能和行为。
- 每个Profile定义了一组具体的操作和数据格式。

### 服务

- 服务是为了实现设备功能所定义的数据集合及相关操作。
- 服务包含特征值和其他服务的引用。

### 特征值

- 特征值包含声明属性和值以及描述该值的信息。
- 特征值用于定义具体的数据和其操作方式。

## 5. ATT (Attribute Protocol)

GATT基于ATT协议，用于定义数据的格式和操作方式。属性（Attribute）是GATT中数据的基本单位，每个属性都有一个UUID，用于唯一标识其类型和用途。

## 6. UUID定义

UUID（通用唯一识别码）用于唯一标识BLE设备中的服务和特征值。UUID是128位的标识符，确保每个服务和特征值在不同设备和应用中具有唯一性。

通过理解GATT和GAP的工作原理，可以更好地设计和实现低功耗蓝牙设备的通信和数据传输。

# UUID有什么作用?

- 在BLE中使用UUID的主要作用是唯一标识服务和特征，以便客户端（如扫描者）能够识别和连接到提供特定服务的设备。UUID（通用唯一标识符）是128位的标识符，用于确保每个服务和特征在不同设备和应用中具有唯一性。以下是UUID在BLE中的几个重要用途：

## 1. 唯一标识服务（Service）

每个BLE服务都有一个唯一的UUID，用于区分不同的服务。例如，心率监测服务和电池服务都有各自的UUID。客户端可以通过UUID识别和连接到特定的服务。

```c
#define HEART_RATE_SERVICE_UUID  0x180D  // 心率服务UUID
#define BATTERY_SERVICE_UUID     0x180F  // 电池服务UUID
```

## 2. 唯一标识特征（Characteristic）

每个特征也有一个唯一的UUID，用于区分同一服务中的不同特征。例如，心率服务可能包含多个特征，如心率测量和心率控制点，每个特征都有自己的UUID。

```c
#define HEART_RATE_MEASUREMENT_UUID  0x2A37  // 心率测量特征UUID
#define BODY_SENSOR_LOCATION_UUID    0x2A38  // 体感传感器位置特征UUID
```

## 3. 通过UUID过滤设备

扫描者可以通过UUID过滤设备，只连接提供特定服务的设备。这对于快速发现并连接到目标设备非常有用。

### 示例：使用UUID过滤设备

在广播数据包中，设备会包含服务UUID。扫描者可以解析这些数据并决定是否连接。

```c
// 示例代码：扫描并连接具有特定服务UUID的BLE设备

static void scan_result_callback(esp_gap_ble_scan_result_evt_param_t *scan_result) {
    if (scan_result->search_evt == ESP_GAP_SEARCH_INQ_RES_EVT) {
        // 解析广播数据包以获取服务UUID
        uint8_t *uuid_list = esp_ble_resolve_adv_data(scan_result->ble_adv, ESP_BLE_AD_TYPE_16SRV_CMPL, NULL, 0);
        uint16_t uuid = (uuid_list[1] << 8) | uuid_list[0];
        if (uuid == HEART_RATE_SERVICE_UUID) {
            // 发现目标服务UUID，发起连接
            esp_ble_gap_stop_scanning();
            esp_ble_gattc_open(gattc_if, scan_result->bda, true);
        }
    }
}
```

## 4. 确保唯一性和互操作性

UUID确保服务和特征在不同设备和应用之间具有唯一性，避免冲突。标准服务和特征使用Bluetooth SIG定义的UUID，定制服务和特征使用随机生成的128位UUID。

### 示例：标准和定制UUID

```c
// 标准UUID（Bluetooth SIG定义）
#define BATTERY_SERVICE_UUID     0x180F  // 电池服务UUID

// 定制UUID（随机生成）
#define CUSTOM_SERVICE_UUID      "12345678-1234-5678-1234-56789abcdef0"
```

通过使用UUID，BLE设备能够准确识别和访问特定的服务和特征，确保互操作性和可靠的通信。